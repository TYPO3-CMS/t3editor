'use strict';(function(h){"object"==typeof exports&&"object"==typeof module?h(require("../../lib/codemirror"),require("../xml/xml"),require("../meta")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../xml/xml","../meta"],h):h(CodeMirror)})(function(h){h.defineMode("markdown",function(x,d){function w(b,a,c){a.f=a.inline=c;return c(b,a)}function y(b){return!b||!/\S/.test(b.string)}function z(b){b.linkTitle=!1;b.em=!1;b.strong=!1;b.strikethrough=!1;b.quote=0;b.indentedCode=!1;
b.f==u&&(b.f=m,b.block=n);b.trailingSpace=0;b.trailingSpaceNewLine=!1;b.prevLine=b.thisLine;return b.thisLine=null}function n(b,a){var c=b.sol(),k=!1!==a.list,m=a.indentedCode;a.indentedCode=!1;if(null===a.indentationDiff){var l=a.indentation;a.indentationDiff=a.indentation;if(k){for(a.list=null;l<a.listStack[a.listStack.length-1];)a.listStack.pop(),a.listStack.length?a.indentation=a.listStack[a.listStack.length-1]:a.list=!1;!1!==a.list&&(a.indentationDiff=l-a.listStack[a.listStack.length-1])}}var g=
null;if(4<=a.indentationDiff&&(m||y(a.prevLine)))return b.skipToEnd(),a.indentedCode=!0,e.code;if(b.eatSpace())return null;if((g=b.match(E))&&6>=g[1].length)return a.header=g[1].length,d.highlightFormatting&&(a.formatting="header"),a.f=a.inline,f(a);if(y(a.prevLine)||a.quote||k||m||!(g=b.match(F))){if(b.eat(">"))return a.quote=c?1:a.quote+1,d.highlightFormatting&&(a.formatting="quote"),b.eatSpace(),f(a);if("["===b.peek())return w(b,a,G);if(b.match(H,!0))return a.hr=!0,e.hr;if(g=b.match(I))return c=
g[1]?"ol":"ul",a.indentation=l+b.current().length,a.list=!0,a.listStack.push(a.indentation),d.taskLists&&b.match(A,!1)&&(a.taskList=!0),a.f=a.inline,d.highlightFormatting&&(a.formatting=["list","list-"+c]),f(a);if(d.fencedCodeBlocks&&(g=b.match(J,!0)))return a.fencedChars=g[1],b=g[2],h.findModeByName&&(l=h.findModeByName(b))&&(b=l.mime||l.mimes[0]),b=h.getMode(x,b),a.localMode="null"==b.name?null:b,a.localMode&&(a.localState=h.startState(a.localMode)),a.f=a.block=K,d.highlightFormatting&&(a.formatting=
"code-block"),a.code=-1,f(a)}else return a.header="="==g[0].charAt(0)?1:2,d.highlightFormatting&&(a.formatting="header"),a.f=a.inline,f(a);return w(b,a,a.inline)}function u(b,a){var c=r.token(b,a.htmlState);if(!L){var d=h.innerMode(r,a.htmlState);if("xml"==d.mode.name&&null===d.state.tagStart&&!d.state.context&&d.state.tokenize.isInText||a.md_inside&&-1<b.current().indexOf(">"))a.f=m,a.block=n,a.htmlState=null}return c}function K(b,a){if(a.fencedChars&&b.match(a.fencedChars))return d.highlightFormatting&&
(a.formatting="code-block"),b=f(a),a.localMode=a.localState=null,a.block=n,a.f=m,a.fencedChars=null,a.code=0,b;if(a.fencedChars&&b.skipTo(a.fencedChars))return"comment";if(a.localMode)return a.localMode.token(b,a.localState);b.skipToEnd();return e.code}function f(b){var a=[];if(b.formatting){a.push(e.formatting);"string"===typeof b.formatting&&(b.formatting=[b.formatting]);for(var c=0;c<b.formatting.length;c++)a.push(e.formatting+"-"+b.formatting[c]),"header"===b.formatting[c]&&a.push(e.formatting+
"-"+b.formatting[c]+"-"+b.header),"quote"===b.formatting[c]&&(!d.maxBlockquoteDepth||d.maxBlockquoteDepth>=b.quote?a.push(e.formatting+"-"+b.formatting[c]+"-"+b.quote):a.push("error"))}if(b.taskOpen)return a.push("meta"),a.length?a.join(" "):null;if(b.taskClosed)return a.push("property"),a.length?a.join(" "):null;b.linkHref?a.push(e.linkHref,"url"):(b.strong&&a.push(e.strong),b.em&&a.push(e.em),b.strikethrough&&a.push(e.strikethrough),b.emoji&&a.push(e.emoji),b.linkText&&a.push(e.linkText),b.code&&
a.push(e.code),b.image&&a.push(e.image),b.imageAltText&&a.push(e.imageAltText,"link"),b.imageMarker&&a.push(e.imageMarker));b.header&&a.push(e.header,e.header+"-"+b.header);b.quote&&(a.push(e.quote),!d.maxBlockquoteDepth||d.maxBlockquoteDepth>=b.quote?a.push(e.quote+"-"+b.quote):a.push(e.quote+"-"+d.maxBlockquoteDepth));!1!==b.list&&((c=(b.listStack.length-1)%3)?1===c?a.push(e.list2):a.push(e.list3):a.push(e.list1));b.trailingSpaceNewLine?a.push("trailing-space-new-line"):b.trailingSpace&&a.push("trailing-space-"+
(b.trailingSpace%2?"a":"b"));return a.length?a.join(" "):null}function M(b,a){if(b.match(N,!0))return f(a)}function m(b,a){var c=a.text(b,a);if("undefined"!==typeof c)return c;if(a.list)return a.list=null,f(a);if(a.taskList)return"x"!==b.match(A,!0)[1]?a.taskOpen=!0:a.taskClosed=!0,d.highlightFormatting&&(a.formatting="task"),a.taskList=!1,f(a);a.taskOpen=!1;a.taskClosed=!1;if(a.header&&b.match(/^#+$/,!0))return d.highlightFormatting&&(a.formatting="header"),f(a);c=b.next();if(a.linkTitle){a.linkTitle=
!1;var k=c;"("===c&&(k=")");k=(k+"").replace(/([.?*+^\[\]\\(){}|-])/g,"\\$1");if(b.match(new RegExp("^\\s*(?:[^"+k+"\\\\]+|\\\\\\\\|\\\\.)"+k),!0))return e.linkHref}if("`"===c){c=a.formatting;d.highlightFormatting&&(a.formatting="code");b.eatWhile("`");b=b.current().length;if(0==a.code)return a.code=b,f(a);if(b==a.code)return b=f(a),a.code=0,b;a.formatting=c;return f(a)}if(a.code)return f(a);if("\\"===c&&(b.next(),d.highlightFormatting))return c=f(a),a=e.formatting+"-escape",c?c+" "+a:a;if("!"===
c&&b.match(/\[[^\]]*\] ?(?:\(|\[)/,!1))return a.imageMarker=!0,a.image=!0,d.highlightFormatting&&(a.formatting="image"),f(a);if("["===c&&a.imageMarker&&b.match(/[^\]]*\](\(.*?\)| ?\[.*?\])/,!1))return a.imageMarker=!1,a.imageAltText=!0,d.highlightFormatting&&(a.formatting="image"),f(a);if("]"===c&&a.imageAltText)return d.highlightFormatting&&(a.formatting="image"),c=f(a),a.imageAltText=!1,a.image=!1,a.inline=a.f=B,c;if("["===c&&!a.image)return a.linkText=!0,d.highlightFormatting&&(a.formatting="link"),
f(a);if("]"===c&&a.linkText)return d.highlightFormatting&&(a.formatting="link"),c=f(a),a.linkText=!1,a.inline=a.f=b.match(/\(.*?\)| ?\[.*?\]/,!1)?B:m,c;if("<"===c&&b.match(/^(https?|ftps?):\/\/(?:[^\\>]|\\.)+>/,!1))return a.f=a.inline=C,d.highlightFormatting&&(a.formatting="link"),c=f(a),(c?c+" ":"")+e.linkInline;if("<"===c&&b.match(/^[^> \\]+@(?:[^\\>]|\\.)+>/,!1))return a.f=a.inline=C,d.highlightFormatting&&(a.formatting="link"),c=f(a),(c?c+" ":"")+e.linkEmail;if("<"===c&&b.match(/^(!--|[a-z]+(?:\s+[a-z_:.\-]+(?:\s*=\s*[^ >]+)?)*\s*>)/i,
!1))return c=b.string.indexOf(">",b.pos),-1!=c&&(c=b.string.substring(b.start,c),/markdown\s*=\s*('|"){0,1}1('|"){0,1}/.test(c)&&(a.md_inside=!0)),b.backUp(1),a.htmlState=h.startState(r),c=u,a.f=a.block=c,c(b,a);if("<"===c&&b.match(/^\/\w*?>/))return a.md_inside=!1,"tag";if("*"===c||"_"===c){for(var n=1,l=1==b.pos?" ":b.string.charAt(b.pos-2);3>n&&b.eat(c);)n++;var g=b.peek()||" ",p=!/\s/.test(g)&&(!q.test(g)||/\s/.test(l)||q.test(l)),v=!/\s/.test(l)&&(!q.test(l)||/\s/.test(g)||q.test(g)),t=k=null;
n%2&&(a.em||!p||"*"!==c&&v&&!q.test(l)?a.em!=c||!v||"*"!==c&&p&&!q.test(g)||(k=!1):k=!0);1<n&&(a.strong||!p||"*"!==c&&v&&!q.test(l)?a.strong!=c||!v||"*"!==c&&p&&!q.test(g)||(t=!1):t=!0);if(null!=t||null!=k)return d.highlightFormatting&&(a.formatting=null==k?"strong":null==t?"em":"strong em"),!0===k&&(a.em=c),!0===t&&(a.strong=c),b=f(a),!1===k&&(a.em=!1),!1===t&&(a.strong=!1),b}else if(" "===c&&(b.eat("*")||b.eat("_"))){if(" "===b.peek())return f(a);b.backUp(1)}if(d.strikethrough)if("~"===c&&b.eatWhile(c)){if(a.strikethrough)return d.highlightFormatting&&
(a.formatting="strikethrough"),b=f(a),a.strikethrough=!1,b;if(b.match(/^[^\s]/,!1))return a.strikethrough=!0,d.highlightFormatting&&(a.formatting="strikethrough"),f(a)}else if(" "===c&&b.match(/^~~/,!0)){if(" "===b.peek())return f(a);b.backUp(2)}if(d.emoji&&":"===c&&b.match(/^[a-z_\d+-]+:/))return a.emoji=!0,d.highlightFormatting&&(a.formatting="emoji"),b=f(a),a.emoji=!1,b;" "===c&&(b.match(/ +$/,!1)?a.trailingSpace++:a.trailingSpace&&(a.trailingSpaceNewLine=!0));return f(a)}function C(b,a){if(">"===
b.next())return a.f=a.inline=m,d.highlightFormatting&&(a.formatting="link"),b=f(a),(b?b+" ":"")+e.linkInline;b.match(/^[^>]+/,!0);return e.linkInline}function B(b,a){if(b.eatSpace())return null;b=b.next();return"("===b||"["===b?(a.f=a.inline=O("("===b?")":"]"),d.highlightFormatting&&(a.formatting="link-string"),a.linkHref=!0,f(a)):"error"}function O(b){return function(a,c){if(a.next()===b)return c.f=c.inline=m,d.highlightFormatting&&(c.formatting="link-string"),a=f(c),c.linkHref=!1,a;a.match(P[b]);
c.linkHref=!0;return f(c)}}function G(b,a){return b.match(/^([^\]\\]|\\.)*\]:/,!1)?(a.f=Q,b.next(),d.highlightFormatting&&(a.formatting="link"),a.linkText=!0,f(a)):w(b,a,m)}function Q(b,a){if(b.match(/^\]:/,!0))return a.f=a.inline=R,d.highlightFormatting&&(a.formatting="link"),b=f(a),a.linkText=!1,b;b.match(/^([^\]\\]|\\.)+/,!0);return e.linkText}function R(b,a){if(b.eatSpace())return null;b.match(/^[^\s]+/,!0);void 0===b.peek()?a.linkTitle=!0:b.match(/^(?:\s+(?:"(?:[^"\\]|\\\\|\\.)+"|'(?:[^'\\]|\\\\|\\.)+'|\((?:[^)\\]|\\\\|\\.)+\)))?/,
!0);a.f=a.inline=m;return e.linkHref+" url"}var r=h.getMode(x,"text/html"),L="null"==r.name;void 0===d.highlightFormatting&&(d.highlightFormatting=!1);void 0===d.maxBlockquoteDepth&&(d.maxBlockquoteDepth=0);void 0===d.taskLists&&(d.taskLists=!1);void 0===d.strikethrough&&(d.strikethrough=!1);void 0===d.emoji&&(d.emoji=!1);void 0===d.tokenTypeOverrides&&(d.tokenTypeOverrides={});var e={header:"header",code:"comment",quote:"quote",list1:"variable-2",list2:"variable-3",list3:"keyword",hr:"hr",image:"image",
imageAltText:"image-alt-text",imageMarker:"image-marker",formatting:"formatting",linkInline:"link",linkEmail:"link",linkText:"link",linkHref:"string",em:"em",strong:"strong",strikethrough:"strikethrough",emoji:"builtin"},p;for(p in e)e.hasOwnProperty(p)&&d.tokenTypeOverrides[p]&&(e[p]=d.tokenTypeOverrides[p]);var H=/^([*\-_])(?:\s*\1){2,}\s*$/,I=/^(?:[*\-+]|^[0-9]+([.)]))\s+/,A=/^\[(x| )\](?=\s)/,E=d.allowAtxHeaderWithoutSpace?/^(#+)/:/^(#+)(?: |$)/,F=/^ *(?:\={1,}|-{1,})\s*$/,N=/^[^#!\[\]*_\\<>` "'(~:]+/,
J=new RegExp("^("+(!0===d.fencedCodeBlocks?"~~~+|```+":d.fencedCodeBlocks)+")[ \\t]*([\\w+#-]*)"),q=/[!\"#$%&\'()*+,\-\.\/:;<=>?@\[\\\]^_`{|}~\u2014]/,P={")":/^(?:[^\\\(\)]|\\.|\((?:[^\\\(\)]|\\.)*\))*?(?=\))/,"]":/^(?:[^\\\[\]]|\\.|\[(?:[^\\\[\]]|\\.)*\])*?(?=\])/},D={startState:function(){return{f:n,prevLine:null,thisLine:null,block:n,htmlState:null,indentation:0,inline:m,text:M,formatting:!1,linkText:!1,linkHref:!1,linkTitle:!1,code:0,em:!1,strong:!1,header:0,hr:!1,taskList:!1,list:!1,listStack:[],
quote:0,trailingSpace:0,trailingSpaceNewLine:!1,strikethrough:!1,emoji:!1,fencedChars:null}},copyState:function(b){return{f:b.f,prevLine:b.prevLine,thisLine:b.thisLine,block:b.block,htmlState:b.htmlState&&h.copyState(r,b.htmlState),indentation:b.indentation,localMode:b.localMode,localState:b.localMode?h.copyState(b.localMode,b.localState):null,inline:b.inline,text:b.text,formatting:!1,linkText:b.linkText,linkTitle:b.linkTitle,code:b.code,em:b.em,strong:b.strong,strikethrough:b.strikethrough,emoji:b.emoji,
header:b.header,hr:b.hr,taskList:b.taskList,list:b.list,listStack:b.listStack.slice(0),quote:b.quote,indentedCode:b.indentedCode,trailingSpace:b.trailingSpace,trailingSpaceNewLine:b.trailingSpaceNewLine,md_inside:b.md_inside,fencedChars:b.fencedChars}},token:function(b,a){a.formatting=!1;if(b!=a.thisLine){a.header=0;a.hr=!1;if(b.match(/^\s*$/,!0))return z(a),null;a.prevLine=a.thisLine;a.thisLine=b;a.taskList=!1;a.trailingSpace=0;a.trailingSpaceNewLine=!1;a.f=a.block;if(a.f!=u){var c=b.match(/^\s*/,
!0)[0].replace(/\t/g,"    ").length;a.indentation=c;a.indentationDiff=null;if(0<c)return null}}return a.f(b,a)},innerMode:function(b){return b.block==u?{state:b.htmlState,mode:r}:b.localState?{state:b.localState,mode:b.localMode}:{state:b,mode:D}},indent:function(b,a,c){return b.block==u?r.indent(b.htmlState,a,c):b.localState?b.localMode.indent(b.localState,a,c):h.Pass},blankLine:z,getType:f,closeBrackets:"()[]{}''\"\"``",fold:"markdown"};return D},"xml");h.defineMIME("text/x-markdown","markdown")});
