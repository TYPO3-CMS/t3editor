!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],e):e(CodeMirror)}(function(e){"use strict";function r(e){return e.state.search||(e.state.search=new function(){this.posFrom=this.posTo=this.lastQuery=this.query=null,this.overlay=null})}function n(e){return"string"==typeof e&&e==e.toLowerCase()}function o(e,r,o){return e.getSearchCursor(r,o,{caseFold:n(r),multiline:!0})}function t(e,r,n,o,t){e.openDialog?e.openDialog(r,t,{value:o,selectValueOnOpen:!0}):t(prompt(n,o))}function a(e){return e.replace(/\\([nrt\\])/g,function(e,r){return"n"==r?"\n":"r"==r?"\r":"t"==r?"\t":"\\"==r?"\\":e})}function i(e){var r=e.match(/^\/(.*)\/([a-z]*)$/);if(r)try{e=new RegExp(r[1],-1==r[2].indexOf("i")?"":"i")}catch(e){}else e=a(e);return("string"==typeof e?""==e:e.test(""))&&(e=/x^/),e}function s(e,r,o){var t,a;r.queryText=o,r.query=i(o),e.removeOverlay(r.overlay,n(r.query)),r.overlay=(t=r.query,a=n(r.query),"string"==typeof t?t=new RegExp(t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),a?"gi":"g"):t.global||(t=new RegExp(t.source,t.ignoreCase?"gi":"g")),{token:function(e){t.lastIndex=e.pos;var r=t.exec(e.string);if(r&&r.index==e.pos)return e.pos+=r[0].length||1,"searching";r?e.pos=r.index:e.skipToEnd()}}),e.addOverlay(r.overlay),e.showMatchesOnScrollbar&&(r.annotate&&(r.annotate.clear(),r.annotate=null),r.annotate=e.showMatchesOnScrollbar(r.query,n(r.query)))}function c(n,o,a,i){var c=r(n);if(c.query)return l(n,o);var p,d,y,m,h,g=n.getSelection()||c.lastQuery;if(g instanceof RegExp&&"x^"==g.source&&(g=null),a&&n.openDialog){var v=null,x=function(r,o){e.e_stop(o),r&&(r!=c.queryText&&(s(n,c,r),c.posFrom=c.posTo=n.getCursor()),v&&(v.style.opacity=1),l(n,o.shiftKey,function(e,r){var o;r.line<3&&document.querySelector&&(o=n.display.wrapper.querySelector(".CodeMirror-dialog"))&&o.getBoundingClientRect().bottom-4>n.cursorCoords(r,"window").top&&((v=o).style.opacity=.4)}))};p=n,d=f(n),y=g,m=x,h=function(o,t){var a=e.keyName(o),i=n.getOption("extraKeys"),c=i&&i[a]||e.keyMap[n.getOption("keyMap")][a];"findNext"==c||"findPrev"==c||"findPersistentNext"==c||"findPersistentPrev"==c?(e.e_stop(o),s(n,r(n),t),n.execCommand(c)):"find"!=c&&"findPersistent"!=c||(e.e_stop(o),x(t,o))},p.openDialog(d,m,{value:y,selectValueOnOpen:!0,closeOnEnter:!1,onClose:function(){u(p)},onKeyDown:h}),i&&g&&(s(n,c,g),l(n,o))}else t(n,f(n),"Search for:",g,function(e){e&&!c.query&&n.operation(function(){s(n,c,e),c.posFrom=c.posTo=n.getCursor(),l(n,o)})})}function l(n,t,a){n.operation(function(){var i=r(n),s=o(n,i.query,t?i.posFrom:i.posTo);(s.find(t)||(s=o(n,i.query,t?e.Pos(n.lastLine()):e.Pos(n.firstLine(),0))).find(t))&&(n.setSelection(s.from(),s.to()),n.scrollIntoView({from:s.from(),to:s.to()},20),i.posFrom=s.from(),i.posTo=s.to(),a&&a(s.from(),s.to()))})}function u(e){e.operation(function(){var n=r(e);n.lastQuery=n.query,n.query&&(n.query=n.queryText=null,e.removeOverlay(n.overlay),n.annotate&&(n.annotate.clear(),n.annotate=null))})}function f(e){return'<span class="CodeMirror-search-label">'+e.phrase("Search:")+'</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">'+e.phrase("(Use /re/ syntax for regexp search)")+"</span>"}function p(e,r,n){e.operation(function(){for(var t=o(e,r);t.findNext();)if("string"!=typeof r){var a=e.getRange(t.from(),t.to()).match(r);t.replace(n.replace(/\$(\d)/g,function(e,r){return a[r]}))}else t.replace(n)})}function d(e,n){if(!e.getOption("readOnly")){var s=e.getSelection()||r(e).lastQuery,c='<span class="CodeMirror-search-label">'+(n?e.phrase("Replace all:"):e.phrase("Replace:"))+"</span>";t(e,c+(' <input type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">'+e.phrase("(Use /re/ syntax for regexp search)")+"</span>"),c,s,function(r){r&&(r=i(r),t(e,'<span class="CodeMirror-search-label">'+e.phrase("With:")+'</span> <input type="text" style="width: 10em" class="CodeMirror-search-field"/>',e.phrase("Replace with:"),"",function(t){if(t=a(t),n)p(e,r,t);else{u(e);var i=o(e,r,e.getCursor("from")),s=function(){var n,a,l,u,f,d,y=i.from();!(n=i.findNext())&&(i=o(e,r),!(n=i.findNext())||y&&i.from().line==y.line&&i.from().ch==y.ch)||(e.setSelection(i.from(),i.to()),e.scrollIntoView({from:i.from(),to:i.to()}),a=e,l='<span class="CodeMirror-search-label">'+(d=e).phrase("Replace?")+"</span> <button>"+d.phrase("Yes")+"</button> <button>"+d.phrase("No")+"</button> <button>"+d.phrase("All")+"</button> <button>"+d.phrase("Stop")+"</button> ",u=e.phrase("Replace?"),f=[function(){c(n)},s,function(){p(e,r,t)}],a.openConfirm?a.openConfirm(l,f):confirm(u)&&f[0]())},c=function(e){i.replace("string"==typeof r?t:t.replace(/\$(\d)/g,function(r,n){return e[n]})),s()};s()}}))})}}e.commands.find=function(e){u(e),c(e)},e.commands.findPersistent=function(e){u(e),c(e,!1,!0)},e.commands.findPersistentNext=function(e){c(e,!1,!0,!0)},e.commands.findPersistentPrev=function(e){c(e,!0,!0,!0)},e.commands.findNext=c,e.commands.findPrev=function(e){c(e,!0)},e.commands.clearSearch=u,e.commands.replace=d,e.commands.replaceAll=function(e){d(e,!0)}});